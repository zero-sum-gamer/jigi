<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>jigi</title>
  <script>
    let kanjiMeaningsDict;
    const fetchKanjiMeanings = async () => {
      try {
        const response = await fetch('kanji-meanings-dict.json')
        kanjiMeaningsDict = await response.json();
        console.log(kanjiMeaningsDict);
      } catch (error) {
        console.error('Error loading Kanji Meanings:', error);
      }
    }
    fetchKanjiMeanings();

    const getMeaningsForKanji = (text) => {
      let meanings = {};
      for (const character of text) {
        const kanjiMeanings = kanjiMeaningsDict[character];
        if (!!Object.keys(kanjiMeanings)) {
          meanings[character] = kanjiMeanings["Meanings"];
        }
      }
      return meanings;
    };

    const populateMeaningsLists = () => {
      const meaningsLists = document.getElementById('meanings-lists');
      const kanjiMeanings = getMeaningsForKanji(previousText);

      // Clear existing table content and repopulate table with kanji meanings
      if (!!meaningsLists) meaningsLists.innerHTML = '';
      for (const kanji in kanjiMeanings) {
        const ul = document.createElement('ul');
        for (const meaning of kanjiMeanings[kanji]) {
          if (!!meaning.trim().length) {
            const li = document.createElement('li');
            li.textContent = meaning;
            ul.appendChild(li);
          } else {
            break;
          }
        }
        meaningsLists.appendChild(ul);
      }
    };
  </script>
  <script>
    let previousText;
    document.addEventListener('DOMContentLoaded', (event) => {
      const clipboardContentList = document.getElementById('clipboard-contents');

      // let previousMeanings;
      // const copyToClipboard = async () => {
      //   try {
      //     if (content !== previousMeanings) {
      //       await navigator.clipboard.writeText(content);
      //       previousMeanings = content;
      //     }
      //   } catch (err) {
      //     console.error('Failed to copy: ', err);
      //   }
      // }

      let callbackProcessInsertedContent = function (mutations) {
        mutations.forEach((mutation) => {
          if (mutation.target == document.body && mutation.type == 'childList' && mutation.addedNodes.length >= 1) {
            let p;
            mutation.addedNodes.forEach((node) => {
              if (node.tagName == 'P') p = node;
            })
            if (!p) return;

            // Get its text content and add the text to a new row in the table, then remove the <p> element.
            let text = p.textContent
            if (text !== previousText) {
              const li = document.createElement('li');
              li.textContent = text;
              clipboardContentList.appendChild(li);
              previousText = text;
              p.remove()
            }
          };
        });
      };

      //Register the above new line callbackProcessInsertedContent function.
      let observer = new MutationObserver(callbackProcessInsertedContent)
      let observerOptions = { childList: true, attributes: false };
      observer.observe(document.body, observerOptions)
    });
  </script>
</head>

<body>
  <h1>jigi</h1>
  <!-- <button type="button" onclick="copyToClipboard()">Start!</button> -->
  <ul id="clipboard-contents">
    <li>-- Clipboard Text Goes Here --</li>
  </ul>
  <button type="button" onclick="populateMeaningsLists()">Find Meanings</button>
  <div id="meanings-lists"></div>
</body>

</html>